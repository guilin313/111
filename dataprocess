import os
import numpy as np
import tifffile as tiff

source_directory = "path/to/source"  # åŸå§‹ TIFF æ–‡ä»¶ç›®å½•
target_directory = "path/to/target"  # è£å‰ªåå­˜æ”¾ç›®å½•

def is_mostly_black(image, threshold=0.1):
    """åˆ¤æ–­è£å‰ªå—æ˜¯å¦è¶…è¿‡ threshold æ¯”ä¾‹çš„é»‘è‰²ï¼ˆåƒç´ å€¼ 0ï¼‰"""
    total_pixels = np.prod(image.shape)
    black_pixels = np.sum(image == 0)
    return (black_pixels / total_pixels) > threshold

def crop_and_save_tif(source_file, target_folder, crop_size=(32, 320, 320), black_threshold=0.1):
    """è£å‰ª TIFF å¹¶ä¿å­˜ï¼Œä¸ä¿å­˜é»‘è‰²åŒºåŸŸè¶…è¿‡ 10% çš„å›¾åƒå—"""
    try:
        data = tiff.imread(source_file)
        if data.ndim != 3:
            print(f"ğŸš« {source_file} ä¸æ˜¯ 3D å›¾åƒï¼Œè·³è¿‡")
            return

        depth, height, width = data.shape
        crop_d, crop_h, crop_w = crop_size
        d_crops = depth // crop_d
        h_crops = height // crop_h
        w_crops = width // crop_w

        if d_crops == 0 or h_crops == 0 or w_crops == 0:
            print(f"âš ï¸ {source_file} å°ºå¯¸ {data.shape} è¿‡å°ï¼Œæ— æ³•è£å‰ªï¼Œè·³è¿‡")
            return

        print(f"âœ‚ï¸ {source_file} -> é¢„è®¡è£å‰ª {d_crops * h_crops * w_crops} ç‰‡")

        file_base = os.path.splitext(os.path.basename(source_file))[0]  # è·å–åŸæ–‡ä»¶åï¼ˆæ— æ‰©å±•åï¼‰
        saved_count = 0  # è®°å½•æˆåŠŸä¿å­˜çš„è£å‰ªå—æ•°

        for d in range(d_crops):
            for h in range(h_crops):
                for w in range(w_crops):
                    cropped = data[
                        d * crop_d : (d + 1) * crop_d,
                        h * crop_h : (h + 1) * crop_h,
                        w * crop_w : (w + 1) * crop_w,
                    ]

                    if is_mostly_black(cropped, threshold=black_threshold):
                        print(f"âš ï¸ è·³è¿‡å…¨é»‘åŒºåŸŸè¿‡å¤šçš„è£å‰ªå— {saved_count + 1}")
                        continue

                    saved_count += 1
                    target_file = os.path.join(target_folder, f"{file_base}_{saved_count}.tif")
                    tiff.imwrite(target_file, cropped.astype(np.float32))

        if saved_count == 0:
            print(f"âš ï¸ {source_file} æ²¡æœ‰æœ‰æ•ˆè£å‰ªæ•°æ®")
        else:
            print(f"âœ… å·²ä¿å­˜ {saved_count} ç‰‡: {target_folder}")

    except Exception as e:
        print(f"âŒ å¤„ç† {source_file} å¤±è´¥: {e}")

def process_directory(source_dir, target_dir, crop_size=(32, 320, 320)):
    """éå†æ–‡ä»¶å¤¹ï¼Œè£å‰ª TIFF å¹¶ä¿å­˜"""
    tif_count = 0

    for root, _, files in os.walk(source_dir):
        relative_path = os.path.relpath(root, source_dir)
        target_subdir = os.path.join(target_dir, relative_path)
        os.makedirs(target_subdir, exist_ok=True)

        for file in files:
            if file.endswith(".tif"):
                tif_count += 1
                source_file = os.path.join(root, file)
                crop_and_save_tif(source_file, target_subdir, crop_size)

    if tif_count == 0:
        print(f"âš ï¸ æœªæ‰¾åˆ°ä»»ä½• .tif æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„: {source_dir}")

if __name__ == "__main__":
    process_directory(source_directory, target_directory)







import os
import h5py
import numpy as np
import tifffile as tiff

source_directory = "path/to/source"  # è¯·æ›¿æ¢ä¸ºä½ çš„ h5 æ–‡ä»¶æ‰€åœ¨ç›®å½•
target_directory = "path/to/target"  # è¯·æ›¿æ¢ä¸ºç›®æ ‡ tif å­˜æ”¾ç›®å½•

def is_abnormal_image(data, black_threshold=0.33):
    """æ£€æµ‹å›¾åƒæ˜¯å¦å¼‚å¸¸ï¼ˆå…¨é»‘ã€å…¨ç™½ æˆ–è€… 1/3 ä»¥ä¸ŠåŒºåŸŸæ˜¯é»‘çš„ï¼‰ã€‚"""
    min_val, max_val = np.min(data), np.max(data)

    # ğŸš« å…¨é»‘æˆ–å…¨ç™½çš„æƒ…å†µ
    if min_val == max_val:
        print(f"ğŸš« è¯¥æ•°æ®æ˜¯å…¨é»‘æˆ–å…¨ç™½")
        return True

    # è®¡ç®—é»‘è‰²åƒç´ æ¯”ä¾‹
    black_pixels = np.sum(data == min_val)  # ç»Ÿè®¡é»‘è‰²åƒç´ 
    total_pixels = data.size
    black_ratio = black_pixels / total_pixels

    print(f"ğŸ“Š é»‘è‰²åŒºåŸŸå æ¯”: {black_ratio:.2%}")

    if black_ratio > black_threshold:
        print(f"ğŸš« é»‘è‰²åŒºåŸŸè¶…è¿‡ {black_threshold*100:.0f}% ({black_ratio:.2%})ï¼Œè·³è¿‡")
        return True

    return False

def convert_h5_to_tif(source_file, target_file):
    """è¯»å– .h5 æ–‡ä»¶å¹¶è½¬æ¢ä¸º .tifï¼Œå¦‚æœæ•°æ®å¼‚å¸¸åˆ™è·³è¿‡ã€‚"""
    try:
        with h5py.File(source_file, "r") as h5f:
            print(f"ğŸ” å¤„ç†æ–‡ä»¶ï¼š{source_file}")

            # æ£€æŸ¥ 'main' å…³é”®å­—æ˜¯å¦å­˜åœ¨
            if "main" not in h5f:
                print(f"âš ï¸ {source_file} æœªæ‰¾åˆ° 'main'ï¼Œå®é™… keysï¼š{list(h5f.keys())}ï¼Œè·³è¿‡")
                return
            
            # è¯»å–æ•°æ®
            data = h5f["main"][:]
            print(f"ğŸ“ æ•°æ®å½¢çŠ¶ï¼š{data.shape}")

            # ç¡®ä¿æ˜¯ 3D æ•°æ®
            if data.ndim != 3:
                print(f"ğŸš« {source_file} ä¸æ˜¯ 3D æ•°æ®ï¼Œè·³è¿‡")
                return

            # åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚å¸¸å›¾åƒ
            if is_abnormal_image(data):
                print(f"ğŸš« {source_file} æ˜¯å¼‚å¸¸å›¾åƒï¼Œè·³è¿‡")
                return

            # ä¿å­˜ä¸º TIFF
            tiff.imwrite(target_file, data.astype(np.float32))
            print(f"âœ… {source_file} â†’ {target_file}")

    except Exception as e:
        print(f"âŒ å¤„ç† {source_file} æ—¶å‡ºé”™ï¼š{e}")

def process_directory(source_dir, target_dir):
    """éå†æºæ–‡ä»¶å¤¹ï¼ŒæŸ¥æ‰¾ .h5 å¹¶è½¬æ¢ä¸º .tifã€‚"""
    h5_files_count = 0

    for root, _, files in os.walk(source_dir):
        relative_path = os.path.relpath(root, source_dir)
        target_subdir = os.path.join(target_dir, relative_path)
        os.makedirs(target_subdir, exist_ok=True)  # ç¡®ä¿å­æ–‡ä»¶å¤¹å­˜åœ¨

        for file in files:
            if file.endswith(".h5"):
                h5_files_count += 1
                source_file = os.path.join(root, file)
                target_file = os.path.join(target_subdir, file.replace(".h5", ".tif"))
                convert_h5_to_tif(source_file, target_file)
    
    if h5_files_count == 0:
        print(f"âš ï¸ æœªåœ¨ {source_dir} å‘ç° .h5 æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼")

if __name__ == "__main__":
    process_directory(source_directory, target_directory)
