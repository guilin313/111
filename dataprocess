import os
import h5py
import numpy as np
import tifffile as tiff

# è®¾ç½®æºå’Œç›®æ ‡æ–‡ä»¶å¤¹
source_directory = "path/to/source"  # ä¿®æ”¹ä¸ºå®é™… h5 æ–‡ä»¶æ‰€åœ¨ç›®å½•
target_directory = "path/to/target"  # ä¿®æ”¹ä¸ºå®é™…å­˜æ”¾ tif çš„ç›®å½•

def is_abnormal_image(data):
    """
    æ£€æµ‹å›¾åƒæ˜¯å¦ä¸ºå¼‚å¸¸ï¼ˆå…¨é»‘æˆ–å…¨ç™½ï¼‰ã€‚
    """
    min_val, max_val = np.min(data), np.max(data)
    return min_val == max_val  # å…¨é»‘æˆ–å…¨ç™½çš„æƒ…å†µ

def convert_h5_to_tif(source_file, target_file):
    """
    è¯»å– .h5 æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå¹¶è½¬æ¢ä¸º .tif æ–‡ä»¶ï¼ˆå¦‚æœæ•°æ®æ­£å¸¸ï¼‰ã€‚
    """
    try:
        with h5py.File(source_file, "r") as h5f:
            if "data" not in h5f:
                print(f"âš ï¸ è­¦å‘Šï¼š{source_file} ä¸­æœªæ‰¾åˆ° 'data' å…³é”®å­—ï¼Œè·³è¿‡è¯¥æ–‡ä»¶ã€‚")
                return
            
            data = h5f["data"][:]
            if data.ndim != 3:  # ç¡®ä¿æ˜¯ 3D æ•°æ®
                print(f"âš ï¸ è­¦å‘Šï¼š{source_file} ä¸æ˜¯ä¸‰ç»´æ•°æ®ï¼Œè·³è¿‡è¯¥æ–‡ä»¶ã€‚")
                return
            
            if is_abnormal_image(data):
                print(f"ğŸš« å¼‚å¸¸æ–‡ä»¶ï¼ˆå…¨é»‘/å…¨ç™½ï¼‰ï¼š{source_file}ï¼Œè·³è¿‡ä¿å­˜ã€‚")
                return

            # ä¿å­˜ä¸º TIFF
            tiff.imwrite(target_file, data.astype(np.float32))
            print(f"âœ… è½¬æ¢æˆåŠŸï¼š{source_file} â†’ {target_file}")

    except Exception as e:
        print(f"âŒ å¤„ç† {source_file} æ—¶å‡ºé”™ï¼š{e}")

def process_directory(source_dir, target_dir):
    """
    éå†æºæ–‡ä»¶å¤¹ï¼ŒæŸ¥æ‰¾ .h5 æ–‡ä»¶å¹¶è½¬æ¢ä¸º .tifã€‚
    """
    for root, _, files in os.walk(source_dir):
        # è®¡ç®—ç›®æ ‡è·¯å¾„
        relative_path = os.path.relpath(root, source_dir)
        target_subdir = os.path.join(target_dir, relative_path)
        os.makedirs(target_subdir, exist_ok=True)  # åˆ›å»ºç›¸åŒç»“æ„çš„ç›®æ ‡æ–‡ä»¶å¤¹

        for file in files:
            if file.endswith(".h5"):
                source_file = os.path.join(root, file)
                target_file = os.path.join(target_subdir, file.replace(".h5", ".tif"))
                convert_h5_to_tif(source_file, target_file)

if __name__ == "__main__":
    process_directory(source_directory, target_directory)
