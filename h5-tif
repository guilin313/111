import os
import h5py
import numpy as np
import tifffile as tiff

source_directory = "path/to/source"  # ä½ çš„ h5 æ–‡ä»¶æ‰€åœ¨ç›®å½•
target_directory = "path/to/target"  # ç›®æ ‡ tif å­˜æ”¾ç›®å½•

def is_abnormal_image(data, black_threshold=0.33, black_value=10):
    """æ£€æµ‹å›¾åƒæ˜¯å¦å¼‚å¸¸ï¼ˆå…¨é»‘ã€å…¨ç™½ æˆ–è€… 1/3 ä»¥ä¸ŠåŒºåŸŸæ˜¯é»‘çš„ï¼‰ã€‚"""
    min_val, max_val = np.min(data), np.max(data)

    # ğŸš« å…¨é»‘æˆ–å…¨ç™½
    if min_val == max_val:
        print(f"ğŸš« è¯¥æ•°æ®æ˜¯å…¨é»‘æˆ–å…¨ç™½")
        return True

    # è®¡ç®—é»‘è‰²åƒç´ æ¯”ä¾‹
    black_pixels = np.sum(data <= black_value)  # è®¾å®šé˜ˆå€¼ï¼Œæ¯”å¦‚ â‰¤10 è®¤ä¸ºæ˜¯é»‘è‰²
    total_pixels = data.size
    black_ratio = black_pixels / total_pixels

    print(f"ğŸ“Š é»‘è‰²åŒºåŸŸå æ¯”: {black_ratio:.2%}")

    if black_ratio > black_threshold:
        print(f"ğŸš« é»‘è‰²åŒºåŸŸè¶…è¿‡ {black_threshold*100:.0f}% ({black_ratio:.2%})ï¼Œè·³è¿‡")
        return True

    return False

def convert_h5_to_tif(source_file, target_file):
    """è¯»å– .h5 æ–‡ä»¶å¹¶è½¬æ¢ä¸º uint8 æ ¼å¼ .tifï¼Œå¦‚æœæ•°æ®å¼‚å¸¸åˆ™è·³è¿‡ã€‚"""
    try:
        with h5py.File(source_file, "r") as h5f:
            print(f"ğŸ” å¤„ç†æ–‡ä»¶ï¼š{source_file}")

            # æ£€æŸ¥ 'main' å…³é”®å­—
            if "main" not in h5f:
                print(f"âš ï¸ {source_file} æœªæ‰¾åˆ° 'main'ï¼Œkeysï¼š{list(h5f.keys())}ï¼Œè·³è¿‡")
                return
            
            # è¯»å–æ•°æ®
            data = h5f["main"][:]
            print(f"ğŸ“ æ•°æ®å½¢çŠ¶ï¼š{data.shape}, dtype: {data.dtype}")

            # ç¡®ä¿æ˜¯ 3D æ•°æ®
            if data.ndim != 3:
                print(f"ğŸš« {source_file} ä¸æ˜¯ 3D æ•°æ®ï¼Œè·³è¿‡")
                return

            # åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚å¸¸å›¾åƒ
            if is_abnormal_image(data):
                print(f"ğŸš« {source_file} æ˜¯å¼‚å¸¸å›¾åƒï¼Œè·³è¿‡")
                return

            # å½’ä¸€åŒ–åˆ° [0, 255] å¹¶è½¬æ¢ä¸º uint8
            data_min, data_max = np.min(data), np.max(data)
            data = ((data - data_min) / (data_max - data_min) * 255).astype(np.uint8)

            # ä¿å­˜ä¸º TIFFï¼ˆuint8ï¼‰
            tiff.imwrite(target_file, data)
            print(f"âœ… {source_file} â†’ {target_file} (uint8)")

    except Exception as e:
        print(f"âŒ å¤„ç† {source_file} æ—¶å‡ºé”™ï¼š{e}")

def process_directory(source_dir, target_dir):
    """éå†æºæ–‡ä»¶å¤¹ï¼ŒæŸ¥æ‰¾ .h5 å¹¶è½¬æ¢ä¸º .tifã€‚"""
    h5_files_count = 0

    for root, _, files in os.walk(source_dir):
        relative_path = os.path.relpath(root, source_dir)
        target_subdir = os.path.join(target_dir, relative_path)
        os.makedirs(target_subdir, exist_ok=True)  # ç¡®ä¿å­æ–‡ä»¶å¤¹å­˜åœ¨

        for file in files:
            if file.endswith(".h5"):
                h5_files_count += 1
                source_file = os.path.join(root, file)
                target_file = os.path.join(target_subdir, file.replace(".h5", ".tif"))
                convert_h5_to_tif(source_file, target_file)
    
    if h5_files_count == 0:
        print(f"âš ï¸ æœªåœ¨ {source_dir} å‘ç° .h5 æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼")

if __name__ == "__main__":
    process_directory(source_directory, target_directory)




inflating: 4096_2048_2300_2400.h5  
  inflating: 2048_4096_600_700.h5    

Archive:  Kasthuri2015_hdf_5.zip
  inflating: 8192_5120_100_200.h5    
  inflating: 9216_7168_800_900.h5    
  inflating: 8192_5120_1700_1800.h5  
  inflating: 7168_4096_800_900.h5    
replace 3072_4096_1200_1300.h5? [y]es, [n]o, [A]ll, [N]one, [r]ename: 






https://github.com/cvlab-stonybrook/SelfMedMAE/blob/main/README.md








import os
import h5py
import numpy as np
from tifffile import imsave

def crop_and_save_h5_to_tiff(input_folder, output_folder, crop_depth=32, crop_height=320, crop_width=320):
    """
    å°†è¾“å…¥æ–‡ä»¶å¤¹ä¸­çš„ HDF5 æ–‡ä»¶è£å‰ªä¸ºæŒ‡å®šå°ºå¯¸çš„ TIFF å›¾åƒï¼Œå¹¶ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ã€‚

    å‚æ•°ï¼š
    - input_folder: åŒ…å« HDF5 æ–‡ä»¶çš„è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„ã€‚
    - output_folder: ä¿å­˜è£å‰ªå TIFF å›¾åƒçš„è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ã€‚
    - crop_depth: è£å‰ªå—çš„æ·±åº¦å°ºå¯¸ï¼Œé»˜è®¤ä¸º 32ã€‚
    - crop_height: è£å‰ªå—çš„é«˜åº¦å°ºå¯¸ï¼Œé»˜è®¤ä¸º 320ã€‚
    - crop_width: è£å‰ªå—çš„å®½åº¦å°ºå¯¸ï¼Œé»˜è®¤ä¸º 320ã€‚
    """
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    for filename in os.listdir(input_folder):
        if filename.endswith('.h5'):
            input_path = os.path.join(input_folder, filename)
            with h5py.File(input_path, 'r') as h5_file:
                # å‡è®¾æ•°æ®å­˜å‚¨åœ¨åä¸º 'data' çš„æ•°æ®é›†ä¸­
                data = h5_file['data'][:]
                depth, height, width = data.shape

                # è®¡ç®—å¯ä»¥å®Œå…¨è£å‰ªçš„åŒºåŸŸ
                max_depth = (depth // crop_depth) * crop_depth
                max_height = (height // crop_height) * crop_height
                max_width = (width // crop_width) * crop_width

                crop_num = 0
                for d in range(0, max_depth, crop_depth):
                    for h in range(0, max_height, crop_height):
                        for w in range(0, max_width, crop_width):
                            crop = data[d:d + crop_depth, h:h + crop_height, w:w + crop_width]
                            crop_num += 1
                            output_filename = f"{os.path.splitext(filename)[0]}_crop_{crop_num}.tif"
                            output_path = os.path.join(output_folder, output_filename)
                            imsave(output_path, crop.astype(np.float32))
                            print(f"ä¿å­˜è£å‰ªå›¾åƒ: {output_path}")

if __name__ == "__main__":
    input_folder = 'path/to/input_folder'  # æ›¿æ¢ä¸ºå®é™…çš„è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„
    output_folder = 'path/to/output_folder'  # æ›¿æ¢ä¸ºå®é™…çš„è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„
    crop_and_save_h5_to_tiff(input_folder, output_folder)
