import os
import tifffile
import numpy as np
from PIL import Image

# 指定四个tif图像路径（支持灰度和彩色混合）
tif_paths = [
    '/path/to/file1.tif',
    '/path/to/file2.tif',
    '/path/to/file3.tif',
    '/path/to/file4.tif',
]

def to_rgb_array(img):
    """确保图像为RGB格式"""
    if img.ndim == 2:  # 灰度图，扩展为 RGB
        return np.stack([img] * 3, axis=-1)
    elif img.ndim == 3:
        if img.shape[2] == 1:  # 单通道但带维度
            return np.concatenate([img] * 3, axis=-1)
        elif img.shape[2] == 3:  # 已是RGB
            return img
        elif img.shape[2] == 4:  # RGBA，去掉Alpha通道
            return img[:, :, :3]
    raise ValueError("Unsupported image format.")

# 读取四张图的第一帧并转换为RGB
images = []
for path in tif_paths:
    img_stack = tifffile.imread(path)
    first_slice = img_stack[0] if img_stack.ndim >= 3 else img_stack
    rgb_img = to_rgb_array(first_slice)
    images.append(rgb_img)

# 转为 PIL 图像
pil_images = [Image.fromarray(img.astype(np.uint8)) for img in images]

# 统一高度和宽度拼接
height = max(img.height for img in pil_images)
total_width = sum(img.width for img in pil_images)

result = Image.new("RGB", (total_width, height))
x_offset = 0
for img in pil_images:
    result.paste(img, (x_offset, 0))
    x_offset += img.width

# 保存到 ./concat 文件夹
output_dir = os.path.join(os.getcwd(), 'concat')
os.makedirs(output_dir, exist_ok=True)
output_path = os.path.join(output_dir, 'concat_output.tif')
result.save(output_path)

print(f"拼接完成，文件已保存到：{output_path}")
